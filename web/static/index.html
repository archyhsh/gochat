<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoChat</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; height: 100vh; overflow: hidden; }
        
        /* ç™»å½•é¡µé¢ */
        .login-container { display: flex; align-items: center; justify-content: center; height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .login-box { background: white; padding: 40px; border-radius: 12px; width: 360px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .login-box h2 { text-align: center; margin-bottom: 30px; color: #333; }
        .login-box .tabs { display: flex; margin-bottom: 20px; }
        .login-box .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; border-bottom: 2px solid #eee; color: #666; }
        .login-box .tab.active { border-bottom-color: #667eea; color: #667eea; font-weight: 600; }
        .login-box .form-group { margin-bottom: 15px; }
        .login-box .form-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .login-box .form-group input:focus { border-color: #667eea; outline: none; }
        .login-box button { width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; }
        .login-box button:hover { background: #5a6fd6; }
        .login-box .message { padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 14px; }
        .login-box .message.error { background: #fee; color: #c00; }
        .login-box .message.success { background: #efe; color: #0a0; }
        .hidden { display: none !important; }

        /* ä¸»èŠå¤©ç•Œé¢ */
        .chat-container { display: flex; height: 100vh; }
        
        /* å·¦ä¾§è¾¹æ  */
        .sidebar { width: 280px; background: #2e3238; display: flex; flex-direction: column; }
        .sidebar-header { padding: 15px; background: #24272c; display: flex; align-items: center; gap: 10px; }
        .sidebar-header .avatar { width: 40px; height: 40px; border-radius: 50%; background: #667eea; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .sidebar-header .user-info { flex: 1; color: white; }
        .sidebar-header .user-info .name { font-weight: 600; }
        .sidebar-header .user-info .status { font-size: 12px; color: #8e9297; }
        .sidebar-header .logout-btn { background: none; border: none; color: #8e9297; cursor: pointer; padding: 5px; }
        .sidebar-header .logout-btn:hover { color: #fff; }

        .sidebar-search { padding: 10px 15px; position: relative; }
        .sidebar-search input { width: 100%; padding: 8px 12px; background: #202225; border: none; border-radius: 4px; color: white; font-size: 13px; }
        .sidebar-search input::placeholder { color: #72767d; }

        .sidebar-tabs { display: flex; border-bottom: 1px solid #202225; }
        .sidebar-tabs .tab { flex: 1; padding: 10px; text-align: center; color: #8e9297; cursor: pointer; font-size: 13px; }
        .sidebar-tabs .tab.active { color: #fff; background: #36393f; }
        .sidebar-tabs .tab:hover { color: #fff; }
        .sidebar-tabs .tab .badge { background: #ed4245; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: 4px; }

        .sidebar-list { flex: 1; overflow-y: auto; }
        .sidebar-list::-webkit-scrollbar { width: 6px; }
        .sidebar-list::-webkit-scrollbar-thumb { background: #202225; border-radius: 3px; }

        .list-item { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; gap: 10px; }
        .list-item:hover { background: #36393f; }
        .list-item.active { background: #393c43; }
        .list-item .avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; flex-shrink: 0; }
        .list-item .info { flex: 1; min-width: 0; }
        .list-item .info .name { color: #fff; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .list-item .info .preview { color: #8e9297; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .list-item .meta { text-align: right; flex-shrink: 0; }
        .list-item .meta .time { color: #72767d; font-size: 11px; }
        .list-item .meta .unread { background: #ed4245; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-top: 4px; display: inline-block; }

        .list-empty { text-align: center; color: #72767d; padding: 40px 20px; }

        /* æœç´¢ç»“æœ */
        .search-results { position: absolute; top: 100%; left: 15px; right: 15px; background: #2e3238; border-radius: 0 0 4px 4px; max-height: 300px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }

        /* å³ä¾§èŠå¤©åŒºåŸŸ */
        .chat-area { flex: 1; display: flex; flex-direction: column; background: #36393f; }
        
        .chat-header { padding: 15px 20px; background: #36393f; border-bottom: 1px solid #202225; display: flex; align-items: center; gap: 10px; }
        .chat-header .avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
        .chat-header .info .name { color: #fff; font-weight: 600; }
        .chat-header .info .status { color: #8e9297; font-size: 12px; }

        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; }
        .chat-messages::-webkit-scrollbar { width: 8px; }
        .chat-messages::-webkit-scrollbar-thumb { background: #202225; border-radius: 4px; }

        .message-group { margin-bottom: 15px; }
        .message-group .sender { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
        .message-group .sender .name { color: #fff; font-weight: 600; font-size: 14px; }
        .message-group .sender .time { color: #72767d; font-size: 11px; }
        .message-bubble { background: #40444b; color: #dcddde; padding: 10px 15px; border-radius: 8px; max-width: 70%; margin-bottom: 4px; word-wrap: break-word; font-size: 14px; line-height: 1.4; }
        .message-bubble.self { background: #5865f2; color: white; margin-left: auto; }
        
        .load-more { text-align: center; padding: 10px; }
        .load-more button { background: #40444b; color: #b9bbbe; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .load-more button:hover { background: #4f545c; }

        .no-chat-selected { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #72767d; }
        .no-chat-selected .icon { font-size: 64px; margin-bottom: 20px; }
        .no-chat-selected p { font-size: 16px; }

        .chat-input { padding: 15px 20px; background: #36393f; }
        .chat-input-box { display: flex; gap: 10px; background: #40444b; border-radius: 8px; padding: 10px 15px; }
        .chat-input-box input { flex: 1; background: none; border: none; color: #dcddde; font-size: 14px; outline: none; }
        .chat-input-box input::placeholder { color: #72767d; }
        .chat-input-box button { background: #5865f2; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .chat-input-box button:hover { background: #4752c4; }
        .chat-input-box button:disabled { background: #4f545c; cursor: not-allowed; }

        /* è¿æ¥çŠ¶æ€ */
        .connection-status { padding: 5px 10px; font-size: 12px; text-align: center; cursor: pointer; }
        .connection-status.connected { background: #3ba55d; color: white; }
        .connection-status.disconnected { background: #ed4245; color: white; }
        .connection-status.connecting { background: #faa81a; color: white; }

        /* å¥½å‹ç”³è¯· */
        .apply-actions { display: flex; gap: 5px; }
        .apply-actions button { padding: 4px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .apply-actions .accept { background: #3ba55d; color: white; }
        .apply-actions .reject { background: #ed4245; color: white; }

        /* èŠå¤©èœå• */
        .menu-item:hover { background: #40444b; }
    </style>
</head>
<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div class="login-container" id="loginPage">
        <div class="login-box">
            <h2>GoChat</h2>
            <div class="tabs">
                <div class="tab active" onclick="showLoginTab('login')">ç™»å½•</div>
                <div class="tab" onclick="showLoginTab('register')">æ³¨å†Œ</div>
            </div>
            <div id="authMessage"></div>
            
            <div id="loginForm">
                <div class="form-group">
                    <input type="text" id="loginUsername" placeholder="ç”¨æˆ·å">
                </div>
                <div class="form-group">
                    <input type="password" id="loginPassword" placeholder="å¯†ç ">
                </div>
                <button onclick="login()">ç™»å½•</button>
            </div>
            
            <div id="registerForm" class="hidden">
                <div class="form-group">
                    <input type="text" id="regUsername" placeholder="ç”¨æˆ·å (3-50å­—ç¬¦)">
                </div>
                <div class="form-group">
                    <input type="password" id="regPassword" placeholder="å¯†ç  (6-50å­—ç¬¦)">
                </div>
                <div class="form-group">
                    <input type="text" id="regNickname" placeholder="æ˜µç§°">
                </div>
                <button onclick="register()">æ³¨å†Œ</button>
            </div>
        </div>
    </div>

    <!-- ä¸»èŠå¤©ç•Œé¢ -->
    <div class="chat-container hidden" id="chatPage">
        <!-- å·¦ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="avatar" id="myAvatar">U</div>
                <div class="user-info">
                    <div class="name" id="myName">ç”¨æˆ·å</div>
                    <div class="status" id="myStatus">ç¦»çº¿</div>
                </div>
                <button class="logout-btn" onclick="logout()" title="é€€å‡ºç™»å½•">é€€å‡º</button>
            </div>
            
            <div class="connection-status disconnected" id="connectionStatus">æœªè¿æ¥</div>
            
            <div class="sidebar-search">
                <input type="text" id="searchInput" placeholder="æœç´¢ç”¨æˆ·..." onkeyup="handleSearch(event)">
                <div class="search-results hidden" id="searchResults"></div>
            </div>
            
            <div class="sidebar-tabs">
                <div class="tab active" onclick="showSidebarTab('chats')">èŠå¤©</div>
                <div class="tab" onclick="showSidebarTab('friends')">å¥½å‹</div>
                <div class="tab" onclick="showSidebarTab('requests')">ç”³è¯·<span class="badge hidden" id="requestBadge">0</span></div>
            </div>
            
            <div class="sidebar-list" id="chatList">
                <div class="list-empty">æš‚æ— èŠå¤©è®°å½•</div>
            </div>
            <div class="sidebar-list hidden" id="friendList">
                <div class="list-empty">æš‚æ— å¥½å‹</div>
            </div>
            <div class="sidebar-list hidden" id="requestList">
                <div class="list-empty">æš‚æ— å¥½å‹ç”³è¯·</div>
            </div>
        </div>
        
        <!-- å³ä¾§èŠå¤©åŒºåŸŸ -->
        <div class="chat-area">
            <div class="no-chat-selected" id="noChatView">
                <div class="icon">ğŸ’¬</div>
                <p>é€‰æ‹©ä¸€ä¸ªå¥½å‹å¼€å§‹èŠå¤©</p>
            </div>
            
            <div class="hidden" id="chatView" style="display:flex;flex-direction:column;height:100%;">
                <div class="chat-header">
                    <div class="avatar" id="chatAvatar" style="background:#5865f2;">U</div>
                    <div class="info">
                        <div class="name" id="chatName">ç”¨æˆ·å</div>
                        <div class="status" id="chatStatus">åœ¨çº¿</div>
                    </div>
                    <div style="position:relative;">
                        <button onclick="toggleChatMenu()" style="background:none;border:none;color:#fff;cursor:pointer;padding:8px;font-size:20px;">â‹®</button>
                        <div id="chatMenu" class="hidden" style="position:absolute;right:0;top:100%;background:#36393f;border:1px solid #202225;border-radius:6px;min-width:150px;z-index:100;box-shadow:0 4px 12px rgba(0,0,0,0.3);">
                            <div id="blockMenuBtn" class="menu-item" onclick="blockCurrentChat()" style="padding:10px 15px;cursor:pointer;color:#faa81a;">æ‹‰é»‘ç”¨æˆ·</div>
                            <div id="unblockMenuBtn" class="menu-item hidden" onclick="unblockCurrentChat()" style="padding:10px 15px;cursor:pointer;color:#3ba55d;">å–æ¶ˆæ‹‰é»‘</div>
                        </div>
                    </div>
                </div>
                
                <!-- æ‹‰é»‘è­¦å‘Šæ¡ - æˆ‘æ‹‰é»‘äº†å¯¹æ–¹ -->
                <div class="hidden" id="blockWarning" style="background:#faa81a;color:#000;padding:10px 15px;font-size:13px;display:flex;justify-content:space-between;align-items:center;">
                    <span>ä½ å·²æ‹‰é»‘è¯¥ç”¨æˆ·ï¼Œæ¶ˆæ¯ä»…æœ¬åœ°å¯è§ï¼Œå¯¹æ–¹æ— æ³•æ”¶åˆ°</span>
                    <button onclick="unblockCurrentChat()" style="background:#fff;color:#000;border:none;padding:5px 12px;border-radius:4px;cursor:pointer;font-size:12px;">å–æ¶ˆæ‹‰é»‘</button>
                </div>
                
                <!-- è¢«æ‹‰é»‘è­¦å‘Šæ¡ - å¯¹æ–¹æ‹‰é»‘äº†æˆ‘ -->
                <div class="hidden" id="blockedByPeerWarning" style="background:#ed4245;color:#fff;padding:10px 15px;font-size:13px;text-align:center;">
                    å¯¹æ–¹å·²å°†ä½ æ‹‰é»‘ï¼Œæ¶ˆæ¯æ— æ³•é€è¾¾
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="load-more" id="loadMoreBtn">
                        <button onclick="loadMoreMessages()">åŠ è½½æ›´å¤šæ¶ˆæ¯</button>
                    </div>
                </div>
                
                <div class="chat-input">
                    <div class="chat-input-box">
                        <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="handleMessageKeypress(event)">
                        <button onclick="sendMessage()" id="sendBtn">å‘é€</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== é…ç½® ====================
        const USER_API = 'http://localhost:8085';
        const RELATION_API = 'http://localhost:8082';
        const MESSAGE_API = 'http://localhost:8081';
        const WS_URL = 'ws://localhost:8080/ws';

        // ==================== çŠ¶æ€ ====================
        let currentUser = null;
        let authToken = null;
        let ws = null;
        let friends = [];
        let conversations = [];
        let currentChat = null;
        let messageOffset = 0;
        const MESSAGE_LIMIT = 20;

        const COLORS = ['#5865f2', '#3ba55d', '#faa81a', '#ed4245', '#9b59b6', '#e91e63', '#00bcd4', '#ff9800'];
        const getColor = (id) => COLORS[Math.abs(id) % COLORS.length];
        const getInitial = (name) => (name || '?').charAt(0).toUpperCase();

        // ==================== å·¥å…·å‡½æ•° ====================
        async function api(url, options = {}) {
            if (authToken) options.headers = { ...options.headers, 'Authorization': `Bearer ${authToken}` };
            if (options.body && typeof options.body === 'object') {
                options.headers = { ...options.headers, 'Content-Type': 'application/json' };
                options.body = JSON.stringify(options.body);
            }
            return (await fetch(url, options)).json();
        }

        function showMessage(msg, isError = false) {
            const el = document.getElementById('authMessage');
            el.innerHTML = `<div class="message ${isError ? 'error' : 'success'}">${msg}</div>`;
            setTimeout(() => el.innerHTML = '', 3000);
        }

        function formatTime(t) {
            if (!t) return '';
            const d = new Date(t), now = new Date();
            return d.toDateString() === now.toDateString() 
                ? d.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
                : d.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
        }

        function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t || ''; return d.innerHTML; }

        // ==================== ç™»å½•/æ³¨å†Œ ====================
        function showLoginTab(tab) {
            document.querySelectorAll('.login-box .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('loginForm').classList.toggle('hidden', tab !== 'login');
            document.getElementById('registerForm').classList.toggle('hidden', tab !== 'register');
        }

        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            if (!username || !password) { showMessage('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ', true); return; }
            try {
                const data = await api(`${USER_API}/api/v1/login`, { method: 'POST', body: { username, password } });
                if (data.code === 0) {
                    authToken = data.data.token;
                    currentUser = data.data;
                    // ä¿å­˜åˆ° localStorage æŒä¹…åŒ–ç™»å½•çŠ¶æ€
                    saveSession();
                    enterChat();
                }
                else showMessage(data.message || 'ç™»å½•å¤±è´¥', true);
            } catch (e) { showMessage('ç½‘ç»œé”™è¯¯', true); }
        }

        // Session æŒä¹…åŒ–å‡½æ•°
        function saveSession() {
            if (authToken && currentUser) {
                localStorage.setItem('gochat_token', authToken);
                localStorage.setItem('gochat_user', JSON.stringify(currentUser));
            }
        }

        function loadSession() {
            const token = localStorage.getItem('gochat_token');
            const user = localStorage.getItem('gochat_user');
            if (token && user) {
                try {
                    authToken = token;
                    currentUser = JSON.parse(user);
                    return true;
                } catch (e) {
                    clearSession();
                }
            }
            return false;
        }

        function clearSession() {
            localStorage.removeItem('gochat_token');
            localStorage.removeItem('gochat_user');
            authToken = null;
            currentUser = null;
        }

        async function register() {
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value;
            const nickname = document.getElementById('regNickname').value.trim();
            if (!username || !password || !nickname) { showMessage('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ', true); return; }
            try {
                const data = await api(`${USER_API}/api/v1/register`, { method: 'POST', body: { username, password, nickname } });
                if (data.code === 0) { showMessage('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•'); document.getElementById('loginUsername').value = username; document.querySelector('.login-box .tab').click(); }
                else showMessage(data.message || 'æ³¨å†Œå¤±è´¥', true);
            } catch (e) { showMessage('ç½‘ç»œé”™è¯¯', true); }
        }

        function logout() {
            clearSession();
            if (ws) ws.close();
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('chatPage').classList.add('hidden');
        }

        // ==================== è¿›å…¥èŠå¤© ====================
        function enterChat() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('chatPage').classList.remove('hidden');
            document.getElementById('myAvatar').textContent = getInitial(currentUser.nickname);
            document.getElementById('myAvatar').style.background = getColor(currentUser.user_id);
            document.getElementById('myName').textContent = currentUser.nickname;
            loadFriends(); loadRequests(); loadConversations(); connectWebSocket();
        }

        // ==================== WebSocket ====================
        function connectWebSocket() {
            updateConnectionStatus('connecting');
            try {
                ws = new WebSocket(`${WS_URL}?token=${encodeURIComponent(authToken)}&platform=web`);
                ws.onopen = () => updateConnectionStatus('connected');
                ws.onmessage = (e) => { try { handleIncomingMessage(JSON.parse(e.data)); } catch(err) {} };
                ws.onclose = () => { updateConnectionStatus('disconnected'); setTimeout(connectWebSocket, 3000); };
                ws.onerror = () => updateConnectionStatus('disconnected');
            } catch (e) { updateConnectionStatus('disconnected'); }
        }

        function updateConnectionStatus(status) {
            const el = document.getElementById('connectionStatus');
            const s = document.getElementById('myStatus');
            el.className = 'connection-status ' + status;
            if (status === 'connected') { el.textContent = 'å·²è¿æ¥'; s.textContent = 'åœ¨çº¿'; }
            else if (status === 'connecting') { el.textContent = 'è¿æ¥ä¸­...'; s.textContent = 'è¿æ¥ä¸­'; }
            else { el.textContent = 'æœªè¿æ¥ - ç‚¹å‡»é‡è¿'; el.onclick = connectWebSocket; s.textContent = 'ç¦»çº¿'; }
        }

        function handleIncomingMessage(msg) {
            console.log('Received message:', msg); // è°ƒè¯•æ—¥å¿—
            if (msg.type === 'chat') {
                const chatData = msg.data;
                console.log('Chat message from', chatData.sender_id, 'content:', chatData.content);
                
                // åˆ·æ–°ä¼šè¯åˆ—è¡¨
                loadConversations();
                
                // å¦‚æœå½“å‰æ­£åœ¨å’Œå‘é€è€…èŠå¤©ï¼Œæ˜¾ç¤ºæ¶ˆæ¯
                if (currentChat && chatData.sender_id === currentChat.peerId) {
                    appendMessage(chatData);
                } else {
                    // æ”¶åˆ°æ–°æ¶ˆæ¯ä½†ä¸åœ¨å½“å‰èŠå¤©çª—å£ï¼Œå¯ä»¥æ˜¾ç¤ºæç¤º
                    console.log('New message from user', chatData.sender_id, '(not in current chat)');
                }
            } else if (msg.type === 'relation_changed') {
                // å¤„ç†å…³ç³»å˜æ›´äº‹ä»¶ï¼ˆæ‹‰é»‘/å–æ¶ˆæ‹‰é»‘ç­‰ï¼‰
                handleRelationChanged(msg.data);
            } else if (msg.type === 'error') {
                // åœ¨èŠå¤©åŒºåŸŸæ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ï¼Œè€Œä¸æ˜¯å¼¹çª—
                appendSystemMessage(msg.data.message || 'å‘é€å¤±è´¥');
            } else if (msg.type === 'ack') {
                console.log('Message ACK:', msg.data);
            }
        }

        async function handleRelationChanged(data) {
            console.log('Relation changed:', data);
            
            // é‡æ–°åŠ è½½å¥½å‹åˆ—è¡¨ä»¥è·å–æœ€æ–°çŠ¶æ€
            await loadFriends();
            await loadConversations();
            
            // å¦‚æœå½“å‰æ­£åœ¨å’Œè¯¥ç”¨æˆ·èŠå¤©ï¼Œæ›´æ–°èŠå¤©ç•Œé¢çŠ¶æ€
            if (currentChat && currentChat.peerId === data.peer_id) {
                const friend = friends.find(f => f.user_id === data.peer_id);
                if (friend) {
                    currentChat.iBlocked = friend.status === 1;
                    currentChat.blockedByPeer = friend.blocked_by_peer === 1;
                    
                    // æ›´æ–°è­¦å‘Šæ¡æ˜¾ç¤º
                    const blockWarning = document.getElementById('blockWarning');
                    const blockedByPeerWarning = document.getElementById('blockedByPeerWarning');
                    
                    if (currentChat.iBlocked) {
                        blockWarning.classList.remove('hidden');
                        blockWarning.style.display = 'flex';
                    } else {
                        blockWarning.classList.add('hidden');
                        blockWarning.style.display = 'none';
                    }
                    
                    if (currentChat.blockedByPeer) {
                        blockedByPeerWarning.classList.remove('hidden');
                        blockedByPeerWarning.style.display = 'block';
                    } else {
                        blockedByPeerWarning.classList.add('hidden');
                        blockedByPeerWarning.style.display = 'none';
                    }
                    
                    // æ›´æ–°èœå•æŒ‰é’®
                    if (currentChat.iBlocked) {
                        document.getElementById('blockMenuBtn').classList.add('hidden');
                        document.getElementById('unblockMenuBtn').classList.remove('hidden');
                    } else {
                        document.getElementById('blockMenuBtn').classList.remove('hidden');
                        document.getElementById('unblockMenuBtn').classList.add('hidden');
                    }
                    
                    // æ˜¾ç¤ºæç¤º
                    if (data.action === 'unblocked') {
                        appendSystemMessage('å¯¹æ–¹å·²å–æ¶ˆå¯¹ä½ çš„æ‹‰é»‘ï¼Œç°åœ¨å¯ä»¥æ­£å¸¸å‘é€æ¶ˆæ¯');
                    } else if (data.action === 'blocked') {
                        appendSystemMessage('ä½ å·²è¢«å¯¹æ–¹æ‹‰é»‘ï¼Œæ¶ˆæ¯æ— æ³•é€è¾¾');
                    }
                }
            }
        }

        function appendSystemMessage(text) {
            const c = document.getElementById('chatMessages');
            if (!c) return;
            const html = `<div style="text-align:center;color:#ed4245;padding:10px;font-size:13px;background:rgba(237,66,69,0.1);border-radius:4px;margin:10px 0;">${escapeHtml(text)}</div>`;
            c.insertAdjacentHTML('beforeend', html);
            c.scrollTop = c.scrollHeight;
        }

        // ==================== å¥½å‹ ====================
        async function loadFriends() {
            try {
                const data = await api(`${RELATION_API}/api/v1/friends`);
                if (data.code === 0) { friends = data.data || []; renderFriendList(); renderChatList(); }
            } catch (e) {}
        }

        function renderFriendList() {
            const c = document.getElementById('friendList');
            if (!friends.length) { c.innerHTML = '<div class="list-empty">æš‚æ— å¥½å‹</div>'; return; }
            c.innerHTML = friends.map(f => {
                const iBlocked = f.status === 1;
                const blockedByPeer = f.blocked_by_peer === 1;
                let badge = '';
                if (iBlocked && blockedByPeer) {
                    badge = '<span style="background:#ed4245;color:white;font-size:10px;padding:2px 6px;border-radius:10px;margin-left:6px;">äº’ç›¸æ‹‰é»‘</span>';
                } else if (iBlocked) {
                    badge = '<span style="background:#faa81a;color:black;font-size:10px;padding:2px 6px;border-radius:10px;margin-left:6px;">å·²æ‹‰é»‘</span>';
                } else if (blockedByPeer) {
                    badge = '<span style="background:#ed4245;color:white;font-size:10px;padding:2px 6px;border-radius:10px;margin-left:6px;">è¢«æ‹‰é»‘</span>';
                }
                return `
                <div class="list-item" onclick="startChat(${f.user_id}, '${escapeHtml(f.remark || f.nickname)}')">
                    <div class="avatar" style="background:${getColor(f.user_id)}">${getInitial(f.nickname)}</div>
                    <div class="info">
                        <div class="name">${escapeHtml(f.remark || f.nickname)}${badge}</div>
                        <div class="preview">@${escapeHtml(f.username)}</div>
                    </div>
                </div>`;
            }).join('');
        }

        async function loadRequests() {
            try {
                const data = await api(`${RELATION_API}/api/v1/friend/apply/list`);
                if (data.code === 0) {
                    const reqs = data.data || [], pending = reqs.filter(r => r.status === 0);
                    const badge = document.getElementById('requestBadge');
                    if (pending.length) { badge.textContent = pending.length; badge.classList.remove('hidden'); }
                    else badge.classList.add('hidden');
                    renderRequestList(reqs);
                }
            } catch (e) {}
        }

        function renderRequestList(reqs) {
            const c = document.getElementById('requestList');
            if (!reqs.length) { c.innerHTML = '<div class="list-empty">æš‚æ— å¥½å‹ç”³è¯·</div>'; return; }
            c.innerHTML = reqs.map(r => `
                <div class="list-item">
                    <div class="avatar" style="background:${getColor(r.user_id)}">${getInitial(r.nickname)}</div>
                    <div class="info"><div class="name">${escapeHtml(r.nickname)}</div><div class="preview">${r.message ? escapeHtml(r.message) : 'è¯·æ±‚æ·»åŠ å¥½å‹'}</div></div>
                    ${r.status === 0 ? `<div class="apply-actions"><button class="accept" onclick="handleRequest(${r.id}, true)">æ¥å—</button><button class="reject" onclick="handleRequest(${r.id}, false)">æ‹’ç»</button></div>` : `<div style="color:#72767d;font-size:12px;">${r.status === 1 ? 'å·²æ¥å—' : 'å·²æ‹’ç»'}</div>`}
                </div>
            `).join('');
        }

        async function handleRequest(id, accept) {
            try {
                const data = await api(`${RELATION_API}/api/v1/friend/apply/handle`, { method: 'POST', body: { apply_id: id, accept } });
                if (data.code === 0) { loadRequests(); if (accept) loadFriends(); }
            } catch (e) {}
        }

        // ==================== æœç´¢ ====================
        let searchTimeout = null;
        function handleSearch(e) {
            const k = e.target.value.trim();
            clearTimeout(searchTimeout);
            if (!k) { document.getElementById('searchResults').classList.add('hidden'); return; }
            searchTimeout = setTimeout(() => searchUsers(k), 300);
        }

        async function searchUsers(k) {
            try {
                const data = await api(`${USER_API}/api/v1/users/search?keyword=${encodeURIComponent(k)}`);
                if (data.code === 0) renderSearchResults((data.data || []).filter(u => u.id !== currentUser.user_id));
            } catch (e) {}
        }

        function renderSearchResults(users) {
            const c = document.getElementById('searchResults');
            c.innerHTML = users.length ? users.map(u => {
                const isFriend = friends.some(f => f.user_id === u.id);
                return `<div class="list-item">
                    <div class="avatar" style="background:${getColor(u.id)}">${getInitial(u.nickname)}</div>
                    <div class="info"><div class="name">${escapeHtml(u.nickname)}</div><div class="preview">@${escapeHtml(u.username)}</div></div>
                    ${isFriend ? '<div style="color:#3ba55d;font-size:12px;">å·²æ˜¯å¥½å‹</div>' : `<button style="background:#5865f2;color:white;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:12px;" onclick="sendFriendRequest(${u.id})">æ·»åŠ </button>`}
                </div>`;
            }).join('') : '<div class="list-empty">æœªæ‰¾åˆ°ç”¨æˆ·</div>';
            c.classList.remove('hidden');
        }

        async function sendFriendRequest(uid) {
            try {
                const data = await api(`${RELATION_API}/api/v1/friend/apply`, { method: 'POST', body: { to_user_id: uid, message: 'è¯·æ±‚æ·»åŠ å¥½å‹' } });
                if (data.code === 0) { alert('å¥½å‹ç”³è¯·å·²å‘é€'); document.getElementById('searchInput').value = ''; document.getElementById('searchResults').classList.add('hidden'); }
                else alert(data.message || 'å‘é€å¤±è´¥');
            } catch (e) { alert('ç½‘ç»œé”™è¯¯'); }
        }

        // ==================== ä¼šè¯ ====================
        async function loadConversations() {
            try {
                const data = await api(`${MESSAGE_API}/api/v1/conversations?limit=20`);
                if (data.code === 0) { conversations = data.data || []; renderChatList(); }
            } catch (e) { renderChatList(); }
        }

        function renderChatList() {
            const c = document.getElementById('chatList');
            if (conversations.length) {
                c.innerHTML = conversations.map(cv => {
                    const f = friends.find(x => x.user_id === cv.peer_id) || {};
                    const name = f.remark || f.nickname || `ç”¨æˆ·${cv.peer_id}`;
                    const iBlocked = f.status === 1;
                    const blockedByPeer = f.blocked_by_peer === 1;
                    let badge = '';
                    if (iBlocked && blockedByPeer) {
                        badge = '<span style="background:#ed4245;color:white;font-size:10px;padding:2px 6px;border-radius:10px;margin-left:6px;">äº’ç›¸æ‹‰é»‘</span>';
                    } else if (iBlocked) {
                        badge = '<span style="background:#faa81a;color:black;font-size:10px;padding:2px 6px;border-radius:10px;margin-left:6px;">å·²æ‹‰é»‘</span>';
                    } else if (blockedByPeer) {
                        badge = '<span style="background:#ed4245;color:white;font-size:10px;padding:2px 6px;border-radius:10px;margin-left:6px;">è¢«æ‹‰é»‘</span>';
                    }
                    return `<div class="list-item ${currentChat?.peerId === cv.peer_id ? 'active' : ''}" onclick="startChat(${cv.peer_id}, '${escapeHtml(name)}')">
                        <div class="avatar" style="background:${getColor(cv.peer_id)}">${getInitial(name)}</div>
                        <div class="info">
                            <div class="name">${escapeHtml(name)}${badge}</div>
                            <div class="preview">${escapeHtml(cv.last_message || '')}</div>
                        </div>
                        <div class="meta"><div class="time">${formatTime(cv.last_message_time)}</div></div>
                    </div>`;
                }).join('');
            } else if (friends.length) {
                c.innerHTML = friends.map(f => {
                    const iBlocked = f.status === 1;
                    const blockedByPeer = f.blocked_by_peer === 1;
                    let badge = '';
                    if (iBlocked && blockedByPeer) {
                        badge = '<span style="background:#ed4245;color:white;font-size:10px;padding:2px 6px;border-radius:10px;margin-left:6px;">äº’ç›¸æ‹‰é»‘</span>';
                    } else if (iBlocked) {
                        badge = '<span style="background:#faa81a;color:black;font-size:10px;padding:2px 6px;border-radius:10px;margin-left:6px;">å·²æ‹‰é»‘</span>';
                    } else if (blockedByPeer) {
                        badge = '<span style="background:#ed4245;color:white;font-size:10px;padding:2px 6px;border-radius:10px;margin-left:6px;">è¢«æ‹‰é»‘</span>';
                    }
                    return `
                    <div class="list-item ${currentChat?.peerId === f.user_id ? 'active' : ''}" onclick="startChat(${f.user_id}, '${escapeHtml(f.remark || f.nickname)}')">
                        <div class="avatar" style="background:${getColor(f.user_id)}">${getInitial(f.nickname)}</div>
                        <div class="info">
                            <div class="name">${escapeHtml(f.remark || f.nickname)}${badge}</div>
                            <div class="preview">ç‚¹å‡»å¼€å§‹èŠå¤©</div>
                        </div>
                    </div>`;
                }).join('');
            } else {
                c.innerHTML = '<div class="list-empty">æ·»åŠ å¥½å‹å¼€å§‹èŠå¤©</div>';
            }
        }

        // ==================== èŠå¤© ====================
        function startChat(peerId, name) {
            const convId = `conv_${Math.min(currentUser.user_id, peerId)}_${Math.max(currentUser.user_id, peerId)}`;
            
            // æŸ¥æ‰¾å¥½å‹ä¿¡æ¯ï¼Œæ£€æŸ¥æ‹‰é»‘çŠ¶æ€
            const friend = friends.find(f => f.user_id === peerId);
            const iBlocked = friend && friend.status === 1;           // æˆ‘æ‹‰é»‘äº†å¯¹æ–¹
            const blockedByPeer = friend && friend.blocked_by_peer === 1; // å¯¹æ–¹æ‹‰é»‘äº†æˆ‘
            
            currentChat = { id: convId, name, peerId, iBlocked, blockedByPeer };
            messageOffset = 0;
            
            document.getElementById('noChatView').classList.add('hidden');
            document.getElementById('chatView').classList.remove('hidden');
            document.getElementById('chatView').style.display = 'flex';
            document.getElementById('chatAvatar').textContent = getInitial(name);
            document.getElementById('chatAvatar').style.background = getColor(peerId);
            document.getElementById('chatName').textContent = name;
            document.getElementById('chatMessages').innerHTML = '<div class="load-more" id="loadMoreBtn"><button onclick="loadMoreMessages()">åŠ è½½æ›´å¤šæ¶ˆæ¯</button></div>';
            
            // æ˜¾ç¤ºæˆ–éšè—æ‹‰é»‘è­¦å‘Š
            const blockWarning = document.getElementById('blockWarning');
            const blockedByPeerWarning = document.getElementById('blockedByPeerWarning');
            
            // æˆ‘æ‹‰é»‘äº†å¯¹æ–¹
            if (iBlocked) {
                blockWarning.classList.remove('hidden');
                blockWarning.style.display = 'flex';
            } else {
                blockWarning.classList.add('hidden');
                blockWarning.style.display = 'none';
            }
            
            // å¯¹æ–¹æ‹‰é»‘äº†æˆ‘
            if (blockedByPeer) {
                blockedByPeerWarning.classList.remove('hidden');
                blockedByPeerWarning.style.display = 'block';
            } else {
                blockedByPeerWarning.classList.add('hidden');
                blockedByPeerWarning.style.display = 'none';
            }
            
            // æ›´æ–°èœå•æŒ‰é’®æ˜¾ç¤º
            if (iBlocked) {
                document.getElementById('blockMenuBtn').classList.add('hidden');
                document.getElementById('unblockMenuBtn').classList.remove('hidden');
            } else {
                document.getElementById('blockMenuBtn').classList.remove('hidden');
                document.getElementById('unblockMenuBtn').classList.add('hidden');
            }
            
            loadMessages();
            renderChatList();
        }

        async function loadMessages() {
            if (!currentChat) return;
            try {
                const data = await api(`${MESSAGE_API}/api/v1/messages?conversation_id=${currentChat.id}&limit=${MESSAGE_LIMIT}&offset=${messageOffset}`);
                if (data.code === 0) {
                    const msgs = data.data.messages || [];
                    if (msgs.length < MESSAGE_LIMIT) document.getElementById('loadMoreBtn').style.display = 'none';
                    msgs.reverse().forEach(m => appendMessage(m, true));
                    messageOffset += msgs.length;
                }
            } catch (e) {
                console.error('Failed to load messages:', e);
                document.getElementById('loadMoreBtn').innerHTML = '<div style="color:#72767d;font-size:12px;">æš‚æ— å†å²æ¶ˆæ¯</div>';
            }
        }

        function loadMoreMessages() { loadMessages(); }

        function appendMessage(msg, prepend = false) {
            const c = document.getElementById('chatMessages');
            if (!c) return;
            const isSelf = msg.sender_id === currentUser.user_id;
            const html = `<div class="message-group"><div class="sender"><span class="name">${isSelf ? 'æˆ‘' : currentChat.name}</span><span class="time">${formatTime(msg.created_at)}</span></div><div class="message-bubble ${isSelf ? 'self' : ''}">${escapeHtml(msg.content)}</div></div>`;
            if (prepend) document.getElementById('loadMoreBtn').insertAdjacentHTML('afterend', html);
            else { c.insertAdjacentHTML('beforeend', html); c.scrollTop = c.scrollHeight; }
        }

        function handleMessageKeypress(e) { if (e.key === 'Enter') sendMessage(); }

        function sendMessage() {
            if (!ws || ws.readyState !== WebSocket.OPEN) { alert('æœªè¿æ¥åˆ°æœåŠ¡å™¨'); return; }
            if (!currentChat) { alert('è¯·å…ˆé€‰æ‹©èŠå¤©å¯¹è±¡'); return; }
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            if (!content) return;
            
            ws.send(JSON.stringify({
                type: 'chat', trace_id: 'trace_' + Date.now(),
                data: { msg_id: 'msg_' + Date.now(), conversation_id: currentChat.id, receiver_id: currentChat.peerId, msg_type: 1, content, timestamp: Date.now() }
            }));
            
            appendMessage({ sender_id: currentUser.user_id, content, created_at: new Date().toISOString() });
            input.value = '';
        }

        // ==================== ä¾§è¾¹æ  ====================
        function showSidebarTab(tab) {
            document.querySelectorAll('.sidebar-tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('chatList').classList.toggle('hidden', tab !== 'chats');
            document.getElementById('friendList').classList.toggle('hidden', tab !== 'friends');
            document.getElementById('requestList').classList.toggle('hidden', tab !== 'requests');
            if (tab === 'friends') loadFriends();
            if (tab === 'requests') loadRequests();
        }

        // ==================== èŠå¤©èœå• ====================
        function toggleChatMenu() {
            const menu = document.getElementById('chatMenu');
            menu.classList.toggle('hidden');
        }

        // æ‹‰é»‘å½“å‰èŠå¤©ç”¨æˆ·
        async function blockCurrentChat() {
            if (!currentChat || !currentChat.peerId) return;
            
            try {
                const data = await api(`${RELATION_API}/api/v1/friends/${currentChat.peerId}/block`, { method: 'POST' });
                if (data.code === 0) {
                    // æ›´æ–°æœ¬åœ°å¥½å‹åˆ—è¡¨çŠ¶æ€
                    const friend = friends.find(f => f.user_id === currentChat.peerId);
                    if (friend) friend.status = 1;
                    
                    // æ›´æ–°èŠå¤©çŠ¶æ€
                    currentChat.iBlocked = true;
                    
                    // æ˜¾ç¤ºè­¦å‘Šæ¡
                    document.getElementById('blockWarning').classList.remove('hidden');
                    document.getElementById('blockWarning').style.display = 'flex';
                    
                    // éšè—èœå•
                    document.getElementById('chatMenu').classList.add('hidden');
                    
                    // åˆ‡æ¢èœå•æŒ‰é’®
                    document.getElementById('blockMenuBtn').classList.add('hidden');
                    document.getElementById('unblockMenuBtn').classList.remove('hidden');
                    
                    // åˆ·æ–°åˆ—è¡¨
                    renderChatList();
                    renderFriendList();
                    
                    appendSystemMessage('å·²æ‹‰é»‘è¯¥ç”¨æˆ·ï¼Œæ¶ˆæ¯å°†ä»…æœ¬åœ°å¯è§');
                } else {
                    appendSystemMessage(data.message || 'æ‹‰é»‘å¤±è´¥');
                }
            } catch (e) {
                appendSystemMessage('ç½‘ç»œé”™è¯¯ï¼Œæ‹‰é»‘å¤±è´¥');
            }
        }

        // å–æ¶ˆæ‹‰é»‘å½“å‰èŠå¤©ç”¨æˆ·
        async function unblockCurrentChat() {
            if (!currentChat || !currentChat.peerId) return;
            
            try {
                const data = await api(`${RELATION_API}/api/v1/friends/${currentChat.peerId}/unblock`, { method: 'POST' });
                if (data.code === 0) {
                    // æ›´æ–°æœ¬åœ°å¥½å‹åˆ—è¡¨çŠ¶æ€
                    const friend = friends.find(f => f.user_id === currentChat.peerId);
                    if (friend) friend.status = 0;
                    
                    // æ›´æ–°èŠå¤©çŠ¶æ€
                    currentChat.iBlocked = false;
                    
                    // éšè—è­¦å‘Šæ¡
                    document.getElementById('blockWarning').classList.add('hidden');
                    document.getElementById('blockWarning').style.display = 'none';
                    
                    // éšè—èœå•
                    document.getElementById('chatMenu').classList.add('hidden');
                    
                    // åˆ‡æ¢èœå•æŒ‰é’®
                    document.getElementById('blockMenuBtn').classList.remove('hidden');
                    document.getElementById('unblockMenuBtn').classList.add('hidden');
                    
                    // åˆ·æ–°åˆ—è¡¨
                    renderChatList();
                    renderFriendList();
                    
                    appendSystemMessage('å·²å–æ¶ˆæ‹‰é»‘ï¼Œæ¶ˆæ¯å°†æ­£å¸¸å‘é€');
                } else {
                    appendSystemMessage(data.message || 'å–æ¶ˆæ‹‰é»‘å¤±è´¥');
                }
            } catch (e) {
                appendSystemMessage('ç½‘ç»œé”™è¯¯ï¼Œå–æ¶ˆæ‹‰é»‘å¤±è´¥');
            }
        }


        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.sidebar-search')) document.getElementById('searchResults').classList.add('hidden');
            if (!e.target.closest('.chat-header')) document.getElementById('chatMenu').classList.add('hidden');
        });
        document.getElementById('loginPassword').addEventListener('keypress', (e) => { if (e.key === 'Enter') login(); });

        // é¡µé¢åŠ è½½æ—¶å°è¯•æ¢å¤ç™»å½•çŠ¶æ€
        (function initApp() {
            if (loadSession()) {
                // éªŒè¯ token æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
                verifyAndEnterChat();
            }
        })();

        async function verifyAndEnterChat() {
            try {
                // è°ƒç”¨ä¸€ä¸ªéœ€è¦è®¤è¯çš„ API æ¥éªŒè¯ token
                const data = await api(`${RELATION_API}/api/v1/friends`);
                if (data.code === 0) {
                    // Token æœ‰æ•ˆï¼Œè¿›å…¥èŠå¤©
                    enterChat();
                } else if (data.code === 401) {
                    // Token è¿‡æœŸæˆ–æ— æ•ˆ
                    clearSession();
                }
            } catch (e) {
                // ç½‘ç»œé”™è¯¯ï¼Œä¿ç•™ session è®©ç”¨æˆ·é‡è¯•
                console.log('Network error during session verification');
            }
        }
    </script>
</body>
</html>
